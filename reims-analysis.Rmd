---
title: "REIMS sample analysis"
author: "Nathan Alexander"
date: "2024-06-03"
output: 
  html_document:
    theme: flatly
editor_options:
  markdown:
    wrap: sentence
---

### Set up `MPlusAutomation`

```{r, eval=F}
install.packages("devtools")
library(devtools)

install_github("michaelhallquist/MplusAutomation")
```

### Load packages

```{r, echo=F, eval=T, warning=F}
library(MplusAutomation)
library(tidyverse) #collection of R packages designed for data science
library(here) #helps with filepaths
library(gt) # creates tables
library(DiagrammeR) # create path diagrams
here::i_am("reims-analysis.Rmd")
```


### Model

```{r, echo=F, eval=T, fig.align='center'}

grViz(" digraph model {

# The `graph` statement - No editing needed

    graph [layout = dot, overlap = true]
 
# Two `node` statements
 
# One for measured variables (box) 

    node [shape=box]
    mathperson1 mathperson2 mathperson3 mathperson4;
 
# One for latent variables (circle) 
 
    node [shape=circle]
    lca [label=<Mathematics Identity <br/>M<sub>k</sub>>];
    
# `edge` statements
 
    edge [minlen = 2]
    lca -> {mathperson1 mathperson2 mathperson3 mathperson4}
 
 }") 
```

### Data

```{r, echo=T, eval=T, warning=F}
# set data
reims <- read_csv(here("data", "reims_clean.csv"))
```


```{r, echo=T, eval=T, warning=F}
# inspect data
reims
summary(reims)
```


```{r, echo=T, eval=T, warning=F}
# view distribution of indicator variables
table(reims$groupflag)
hist(reims$age)
table(reims$sex)
table(reims$race)

# subset data
reims1 <- reims %>% 
  select(mathperson1, mathperson2, mathperson3, mathperson4)
head(reims1, n=10)

## add ids and covariates; tell mplus that what we are

```


```{r, eval = T}

input <- mplusObject(
  TITLE = "REIMS Mathematics Identity Model",
  VARIABLE = "categorical = mathperson1 mathperson2 mathperson3 mathperson4;
  usevar = mathperson1 mathperson2 mathperson3 mathperson4;
  classes = c(3);",
  
  ANALYSIS =
    "estimator = mlr;
    type = mixture;",
  
  OUTPUT = "tech11 tech14;",
  
  PLOT = "type = plot3;
    series = mathperson1-mathperson4(*);",
  
  usevariables = colnames(reims1),
  rdata = reims1)

output <- mplusModeler(input,
                       dataout = here("mplus", "reims1.dat"),
                       modelout = here("mplus", "reims1.inp"),
                       check = T, run = T, hashfilename = F)

```

Take a look at the item probability plot:

```{r}
source(here("plot_lca.txt")) # custom function created by Dina to plot our lsa output

model <- readModels(here("mplus", "reims1.out")) # read in output

plot_lca(model_name = model) # there is an error with the non atomic measure columns
``` 


Show probability plot of data and then observe the different classes.

---

This file is based on resources provided at the Institute of Mixture Modeling for Equity-Oriented Researchers, Scholars, and Educators (2024). IMMERSE In-Person Training Workshop (IES No. 305B220021).
Institute of Education Sciences.
<https://immerse-ucsb.github.io/pre-training>