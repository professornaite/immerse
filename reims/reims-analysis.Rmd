---
title: "REIMS sample analysis"
author: "Nathan Alexander"
date: "2024-06-03"
output:
  html_document:
    theme: flatly
  pdf_document: default
editor_options:
  markdown:
    wrap: sentence
---

# Set up

### Set up `MPlusAutomation`

```{r, eval=F}
install.packages("devtools")
library(devtools)

install_github("michaelhallquist/MplusAutomation")
```

### Load packages

```{r, echo=F, eval=T, warning=F}
library(MplusAutomation)
library(tidyverse) #collection of R packages designed for data science
library(here) #helps with filepaths
library(gt) # creates tables
library(DiagrammeR) # create path diagrams
here::i_am("reims-analysis.Rmd")
```

### Data

```{r, echo=T, eval=T, warning=F}
# set data
reims <- read_csv(here("data", "reims_clean.csv"))
```


```{r, echo=T, eval=T, warning=F}
# inspect data
reims
summary(reims)
```

#### Make updates/edits to data

We observe some of the other tags on our data. We also look at the distribution of some values. Take note that we changed the variable names (thanks Dina!) to less than eight characters so that our model could run.

```{r, echo=T, eval=T, warning=F}
# view distribution of indicator variables
table(reims$groupflag)
hist(reims$age)
table(reims$sex)
table(reims$race)

# subset data
reims1 <- reims %>% 
  select(mathperson1, mathperson2, mathperson3, mathperson4, dislikemathclass, pursuestem, boysbetter) %>% 
  rename(m1 = mathperson1,
         m2 = mathperson2,
         m3 = mathperson3,
         m4 = mathperson4,
         dislike = dislikemathclass,
         pursue = pursuestem,
         boys = boysbetter)

head(reims1, n=10)

## add ids and covariates; tell mplus that what we are

# use the reorder function to get hte variables that you want to model in the output.

```

# Models

## Model 1

```{r, echo=F, eval=T, fig.align='center'}

grViz(" digraph model {

# The `graph` statement - No editing needed

    graph [layout = dot, overlap = true]
 
# Two `node` statements
 
# One for measured variables (box) 

    node [shape=box]
    mathperson1 mathperson2 mathperson3 mathperson4;
 
# One for latent variables (circle) 
 
    node [shape=circle]
    lca [label=<Mathematics Identity <br/>C<sub>k</sub>>];
    
# `edge` statements
 
    edge [minlen = 2]
    lca -> {mathperson1 mathperson2 mathperson3 mathperson4}
 
 }") 
```

### Model 1 MplusAutomation code

```{r, eval = T}

input <- mplusObject(
  TITLE = "REIMS Mathematics Identity Model 1",
  VARIABLE = "categorical = m1 m2 m3 m4;
  usevar = m1-m4;
  classes = c(3);",
  
  ANALYSIS =
    "estimator = mlr;
    type = mixture;",
  
  OUTPUT = "tech11 tech14;",
  
  PLOT = "type = plot3;
    series = m1-m4(*);",
  
  usevariables = colnames(reims1),
  rdata = reims1)

output <- mplusModeler(input,
                       dataout = here("mplus", "reims1.dat"),
                       modelout = here("mplus", "reims1.inp"),
                       check = T, run = T, hashfilename = F)

```

Take a look at the item probability plot:

```{r}
source(here("plot_lca.txt")) # custom function created by Dina to plot our lsa output

model1 <- readModels(here("mplus", "reims1.out")) # read in output

plot_lca(model_name = model1) # there is an error with the non atomic measure columns
``` 

Show probability plot of data and observe the different classes.

---

## Model 2

Let's run a four class model and add three variables.

```{r, echo=F, eval=T, fig.align='center'}

grViz(" digraph model {

# The `graph` statement - No editing needed

    graph [layout = dot, overlap = true]
 
# Two `node` statements
 
# One for measured variables (box) 

    node [shape=box]
    mathperson1 mathperson2 mathperson3 mathperson4 dislikemathclass pursuestem boysbetter;
 
# One for latent variables (circle) 
 
    node [shape=circle]
    lca [label=<Mathematics Identity <br/>C<sub>k</sub>>];
    
# `edge` statements
 
    edge [minlen = 2]
    lca -> {mathperson1 mathperson2 mathperson3 mathperson4 dislikemathclass pursuestem boysbetter}
 
 }") 
```

### Model 2 MplusAutomation code

```{r, eval = T}

input <- mplusObject(
  TITLE = "REIMS Mathematics Identity Model 2",
  VARIABLE = "categorical = m1 m2 m3 m4 dislike pursue boys;
  usevar = m1-boys;
  classes = c(4);",
  
  ANALYSIS =
    "estimator = mlr;
    type = mixture;",
  
  OUTPUT = "tech11 tech14;",
  
  PLOT = "type = plot3;
    series = m1-boys(*);",
  
  usevariables = colnames(reims1),
  rdata = reims1)

output <- mplusModeler(input,
                       dataout = here("mplus", "reims1.dat"),
                       modelout = here("mplus", "reims1.inp"),
                       check = T, run = T, hashfilename = F)

```

Take a look at the item probability plot:

```{r}
source(here("plot_lca.txt")) # custom function created by Dina to plot our lsa output

model2 <- readModels(here("mplus", "reims1.out")) # read in output

plot_lca(model_name = model2) # there is an error with the non atomic measure columns
``` 

Show probability plot of data and observe the different classes.

---

# Enumeration

We use the mplusObject function in the MPlusAutomation package and saves all models run.

```{r}
# add new libraries
library(cowplot)
library(glue)
```

Proporion of indicators using R:

```{r}

# set up data to find proportions of binary indicators
df <- reims1 %>% 
  pivot_longer(c(m1, m2, m3, m4, dislike, pursue, boys),
  names_to = "Variable")

# create table of variables and counts
t1 <- table(df$Variable, df$value)

# find proportions and round to 3 decimal places
prop <- prop.table(t1, margin =1) %>% 
  round(3)

# combine everything to one table
dframe <- data.frame(Variables=rownames(t1), Proportion=prop[,2], Count=t1[,2])

# remove row names
row.names(dframe) <- NULL

# Make it a gt() table
prop_table <- dframe %>% 
  gt()
prop_table

# save as a word doc
gtsave(prop_table, here("figures", "prop_table.docx"))
```

Use an enumeration function

```{r, eval = F}
lca_4 <- lapply(1:4, function(k) {
  lca_enum <- mplusObject(
    
    TITLE = glue("{k}-Class"),
    
    VARIABLE = glue(
      "categorical m1-boys;
      usevar = m1-boys;
      classes = c({k});"),
    
    ANALYSIS =
      "estimator = mlr;
      type = mixture;
      starts = 500 100;",
    
    OUTPUT = "tech11 tech14 svalues;",
    
    usevariables = colnames(reims1),
    rdata = reims1)
  
  lca_enum_fit <- mplusModeler(lca_enum,
                               dataout = glue(here("reims","enum", "reims1.dat")),
                               modelout = glue(here("reims", "enum", "c{k}_reims1.inp")),
                               check = T, run = T, hashfilename = F)})
```

### table of fit

We want to begin by extracting the data:

```{r}
output_reims1 <- readModels(here("enum"))

enum_extract <- LatexSummaryTable(
  output_reims1,
  keepCols = c(
    "Title",
    "Parameters",
    "LL",
    "BIC",
    "aBIC",
    "BLRT_PValue",
    "T11_VLMR_PValue",
    "Observations"
  ),
  sortBy = "Title"
) # select first set of models (Class 1 through 4)

allFit <- enum_extract %>% 
  mutate(CAIC = -2 * LL + Parameters * (log(Observations) + 1)) %>% 
  mutate(AWE = -2 * LL + 2 * Parameters * (log(Observations) + 1.5)) %>% 
  mutate(SIC = -.5 * BIC) %>% 
  mutate(expSIC = exp(SIC - max(SIC))) %>% 
  mutate(BF = exp(SIC - lead(SIC))) %>% 
  mutate(cmPk = expSIC / sum(expSIC)) %>% 
  dplyr::select(1:5, 9:10, 6:7, 13, 14) %>%
  arrange(Parameters)
```
Then we create a table:

```{r}
fit_table <- allFit %>%
  gt() %>%
  tab_header(title = md("**Model Fit Summary Table**")) %>%
  cols_label(
    Title = "Classes",
    Parameters = md("Par"),
    LL = md("*LL*"),
    T11_VLMR_PValue = "VLMR",
    BLRT_PValue = "BLRT",
    BF = md("BF"),
    cmPk = md("*cmPk*")
  ) %>%
  tab_footnote(
    footnote = md(
      "*Note.* Par = Parameters; *LL* = model log likelihood;
BIC = Bayesian information criterion;
aBIC = sample size adjusted BIC; CAIC = consistent Akaike information criterion;
AWE = approximate weight of evidence criterion;
BLRT = bootstrapped likelihood ratio test p-value;
VLMR = Vuong-Lo-Mendell-Rubin adjusted likelihood ratio test p-value;
*cmPk* = approximate correct model probability."
    ),
locations = cells_title()
  ) %>%
  tab_options(column_labels.font.weight = "bold") %>%
  fmt_number(c(3:7),
             decimals = 2) %>%
  sub_missing(1:11,
              missing_text = "--") %>%
  fmt(
    c(8:9, 11),
    fns = function(x)
      ifelse(x < 0.001, "<.001",
             scales::number(x, accuracy = .01))
  ) %>%
  fmt(
    10,
    fns = function (x)
      ifelse(x > 100, ">100",
             scales::number(x, accuracy = .01))
  ) %>%  
  tab_style(
    style = list(
      cell_text(weight = "bold")

            ),
    locations = list(cells_body(
     columns = BIC,
     row = BIC == min(BIC[1:6]) # Change this to the number of classes you estimated
    ),
    cells_body(
     columns = aBIC,
     row = aBIC == min(aBIC[1:6])
    ),
    cells_body(
     columns = CAIC,
     row = CAIC == min(CAIC[1:6])
    ),
    cells_body(
     columns = AWE,
     row = AWE == min(AWE[1:6])
    ),
    cells_body(
     columns = cmPk,
     row =  cmPk == max(cmPk[1:6])
     ),    
    cells_body(
     columns = BF,
     row =  BF > 10),
    cells_body( 
     columns =  T11_VLMR_PValue,
     row =  ifelse(T11_VLMR_PValue < .001 & lead(T11_VLMR_PValue) > .05, T11_VLMR_PValue < .001, NA)),
    cells_body(
     columns =  BLRT_PValue,
     row =  ifelse(BLRT_PValue < .001 & lead(BLRT_PValue) > .05, BLRT_PValue < .001, NA))
  )
) 

fit_table

```

save the table:

```{r}
gtsave(fit_table, here("figures", "fit_table.png"))
```
---

This file is based on resources provided at the Institute of Mixture Modeling for Equity-Oriented Researchers, Scholars, and Educators (2024). IMMERSE In-Person Training Workshop (IES No. 305B220021).
Institute of Education Sciences.
<https://immerse-ucsb.github.io/pre-training>